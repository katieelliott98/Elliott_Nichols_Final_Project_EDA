---
output: html_document
editor_options: 
  chunk_output_type: console
---
title: "Final Project - Hydro Power Generation and Streamflow Analysis"
author: "Kaitlyn Elliott and Jon Nichols"
output: pdf_document
geometry: margin=2.54cm
editor_options: 
  chunk_output_type: console
---

## Rationale and Research Questions

Hydroelectric power accounts for 52 percent of renewable electricity generation and 7 percent of total electricity generation in the US. These plants are a critical clean energy resource for grid operators and utilities due to their operational flexibility, low maintenance costs, and non-intermittent production. However, hydroelectric generation is susceptible to climate change, and changes in temperature, precipitation patters, glacial melt, and the frequency of extreme weather events such as floods and droughts may have a direct negative effect on electricity production. Thus, the impact of climate change on the variability and availability of streamflow is critical for current hydroelectric generation and future operational forecast plans. 

There are three types of hydropower plants: impoundment facilities that use a dam to store water, run-of-river facilities that generate electricity by channeling water through a turbine and do not use a reservoir, and pumped storage plants. For our analysis, we investigated the impact of climate change on run-of-river facilities, given their unique vulnerability to variations in streamflow. In general, lower stream discharges reduce the amount of electricity a hydropower plant can generate. 

We examine 20 years of streamflow and electric generation data for 9 run-of-river facilities across the US and assess the impact of climate change on stream flows and consequently on the hydropower generation of these plants. We specifically investigate the monotonic trends for streamflow and electric generation at each run-of-river hydropower plant, and then analyze whether stream discharge can explain the variation in observed generation data. The results obtained will allow us to better understand the relationship between hydropower generation and streamflow, while also identifying hydropower plants that are vulnerable to climate change.


## Background and Methods
In this project we set out to explore the relationship between hydro power generation and stream generation. To do this we looked at power generation data from the EPI and stream gage data from the USGS. For generation data we selected generation sites/dams so that half were from the western United States and half from the East. Stream gage data was selected upstream from dams and reservoirs to get an accurate representation of stream flow over time. Both power generation data and stream flow was analyzed for seasonality and monotonic trends using a seasonal man kendall test. This was to help understand if generation was increasing or decreasing as a result of stream flow. Although outside factors could also contribute increases or decreases in power generation.

## Set Up  

```{r}

getwd()

library(tidyverse)
library(lubridate)
library(dataRetrieval)
library(trend)
library(dataRetrieval)
library(cowplot)
library(readr)
library(zoo)
library(Kendall)
#install.packages("tseries")
library(tseries)
library(grid)
library(gridExtra)
library(knitr)
library(sf)
library(mapview)
library(maps)

theme_set(theme_classic())
options(scipen = 6)

```

## Data Retrieval

Hydroelectric generation data was collected from the EIA, and streamflow data was collected from the USGS. Generation data was obtained through the EIA's Electricity Data Browser, which is an interactive query tool. Nine separate queries - one for each hydropower plant- were used to download the data needed for the analysis. For each query, we used the date range January 2001 through December 2021. Data was downloaded as a "Chart (CSV)", which presented four rows of descriptive information and then two columns for the Month and "All primemovers - All fuels (ALL) megawatthours". The descriptive info of each generation dataset was cleaned in Excel to streamline data import into R. 

SOMETHING ABOUT RETRIEVING USGS DATA 

```{r}
#Reading in stream data

#East Stream Gage Sites

gage_02143000<-readNWISdata(siteNumbers = "02143000", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_02071000<-readNWISdata(siteNumbers = "02071000", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_01563200<-readNWISdata(siteNumbers = "01563200", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_01054500<-readNWISdata(siteNumbers = "01054500", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_02163001<-readNWISdata(siteNumbers = "02163001", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

#West Stream Gage Sites

gage_06279940<-readNWISdata(siteNumbers = "06279940", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_13046000<-readNWISdata(siteNumbers = "13046000", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_09146200<-readNWISdata(siteNumbers = "09146200", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

gage_09408135<-readNWISdata(siteNumbers = "09408135", parameterCd = "00060", startDate = "2000-01-01", endDate = "2021-12-31")

#Summarizing Data by Month

gage_01054500 <- gage_01054500 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_01563200<-gage_01563200 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_02071000<-gage_02071000 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_02143000<-gage_02143000 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_02163001<-gage_02163001 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_06279940<-gage_06279940 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_09146200<-gage_09146200 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))


gage_09408135<-gage_09408135 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))

gage_13046000<-gage_13046000 %>%
  mutate(Discharge = X_00060_00003) %>%
  select(Discharge, dateTime, site_no) %>%
  mutate(Month = month(dateTime), Year= year(dateTime)) %>%
  group_by(Year, Month) %>%
  summarize(average_monthly_discharge = mean(Discharge)) %>%
  mutate(day="01",date=as.Date(paste(Month, day, Year, sep = "-"),
                               format="%m-%d-%Y"))
#Reading in generation data
High_Shoals_Generation <- read.csv("./Final Project Hydro Generation Data/High_Shoals_Hydro_(NC)_net_generation (1).csv")

Schoolfield_Generation <- read.csv("./Final Project Hydro Generation Data/Schoolfield_Dam_net_generation.csv")

Matson_Generation <- read.csv("./Final Project Hydro Generation Data/William_F_Matson_Generating_Station_net_generation.csv")

Otis_Generation <- read.csv("./Final Project Hydro Generation Data/Otis_Hydro_net_generation.csv")

Ware_Shoals_Generation <- read.csv("./Final Project Hydro Generation Data/Ware_Shoals_Hydro_Project_net_generation.csv")

Garland_Generation <- read.csv("./Final Project Hydro Generation Data/Garland_Canal_Power_Plant_net_generation.csv")

Chester_Generation <- read.csv("./Final Project Hydro Generation Data/Chester_Diversion_Hydroelectric_Project_net_generation.csv")

Tri_County_Generation <- read.csv("./Final Project Hydro Generation Data/Tri-County_Water_Hydropower_Project_net_generation.csv")

Quail_Creek_Generation <- read.csv("./Final Project Hydro Generation Data/Quail_Creek_Hydro_Plant_#1_net_generation.csv")


High_Shoals_Generation <- High_Shoals_Generation[-c(1),]
Schoolfield_Generation <- Schoolfield_Generation[-c(1),]
Matson_Generation <- Matson_Generation[-c(1),]
Otis_Generation <- Otis_Generation[-c(1),]
Ware_Shoals_Generation <-Ware_Shoals_Generation[-c(1),] 
Garland_Generation <- Garland_Generation[-c(1),]
Chester_Generation <- Chester_Generation[-c(1),]
Tri_County_Generation <- Tri_County_Generation[-c(1),]
Quail_Creek_Generation <- Quail_Creek_Generation[-c(1),]

colnames(High_Shoals_Generation) <- c("date_wrong", "Power")
colnames(Schoolfield_Generation) <- c("date_wrong", "Power")
colnames(Matson_Generation) <- c("date_wrong", "Power")
colnames(Otis_Generation) <- c("date_wrong", "Power")
colnames(Ware_Shoals_Generation) <- c("date_wrong", "Power")
colnames(Garland_Generation) <- c("date_wrong", "Power")
colnames(Chester_Generation) <- c("date_wrong", "Power")
colnames(Tri_County_Generation) <- c("date_wrong", "Power")
colnames(Quail_Creek_Generation) <- c("date_wrong", "Power")

High_Shoals_Generation <- High_Shoals_Generation %>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Schoolfield_Generation <- Schoolfield_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Matson_Generation <- Matson_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Otis_Generation <- Otis_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Ware_Shoals_Generation <-Ware_Shoals_Generation %>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Garland_Generation <- Garland_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Chester_Generation <- Chester_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Tri_County_Generation <- Tri_County_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))
Quail_Creek_Generation <- Quail_Creek_Generation%>%
  mutate(Date = as.Date(paste(date_wrong, "-01", sep=""), format = "%b-%y-%d"))

High_Shoals_Generation <- High_Shoals_Generation %>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)
  

Schoolfield_Generation <- Schoolfield_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Matson_Generation <- Matson_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Otis_Generation <- Otis_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Ware_Shoals_Generation <-Ware_Shoals_Generation %>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Garland_Generation <- Garland_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Chester_Generation <- Chester_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)

Tri_County_Generation <- Tri_County_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)


Quail_Creek_Generation <- Quail_Creek_Generation%>%
  mutate(Month = month(Date))%>%
mutate(Year = year(Date))%>%
  select(Date, Month, Year, Power)%>%
  transform(Power = as.numeric(Power))%>%
  arrange(Date)



High_Shoals_Generation_Complete <-  High_Shoals_Generation[!(is.na(High_Shoals_Generation$Power) | High_Shoals_Generation$Power==""), ]

Schoolfield_Generation_Complete <-  Schoolfield_Generation[!(is.na(Schoolfield_Generation$Power) | Schoolfield_Generation$Power==""), ]

Matson_Generation_Complete <-  Matson_Generation[!(is.na(Matson_Generation$Power) | Matson_Generation$Power==""), ]

Otis_Generation_Complete <-  Otis_Generation[!(is.na(Otis_Generation$Power) | Otis_Generation$Power==""), ]

Ware_Shoals_Generation_Complete <-  Ware_Shoals_Generation[!(is.na(Ware_Shoals_Generation$Power) | Ware_Shoals_Generation$Power==""), ]

Garland_Generation_Complete <-  Garland_Generation[!(is.na(Garland_Generation$Power) | Garland_Generation$Power==""), ]

Chester_Generation_Complete <-  Chester_Generation[!(is.na(Chester_Generation$Power) | Chester_Generation$Power==""), ]

Tri_County_Generation_Complete <-  Tri_County_Generation[!(is.na(Tri_County_Generation$Power) | Tri_County_Generation$Power==""), ]

Quail_Creek_Generation_Complete <-  Quail_Creek_Generation[!(is.na(Quail_Creek_Generation$Power) | Quail_Creek_Generation$Power==""), ]


```

## Discharge Visualization

```{r}

plot1<-ggplot(gage_01054500, aes(x=date, y=average_monthly_discharge))+geom_line(color="blue")+labs(x="", y="", title = "Gage 01054500")+ylim(0,15000)
plot2<-ggplot(gage_01563200, aes(x=date, y=average_monthly_discharge))+geom_line(color="blue")+labs(x="", y="", title = "Gage 01563200")+ylim(0,15000)
plot3<-ggplot(gage_02071000, aes(x=date, y=average_monthly_discharge))+geom_line(color="blue")+labs(x="", y="", title = "Gage 02071000")+ylim(0,15000)
plot4<-ggplot(gage_02143000, aes(x=date, y=average_monthly_discharge))+geom_line(color="blue")+labs(x="", y="", title = "Gage 02143000")+ylim(0,15000)
plot5<-ggplot(gage_02163001, aes(x=date, y=average_monthly_discharge))+geom_line(color="blue")+labs(x="", y="", title = "Gage 02163001")+ylim(0,15000)
plot6<-ggplot(gage_06279940, aes(x=date, y=average_monthly_discharge))+geom_line(color="red")+labs(x="", y="", title = "Gage 06279940")+ylim(0,15000)
plot7<-ggplot(gage_09146200, aes(x=date, y=average_monthly_discharge))+geom_line(color="red")+labs(x="", y="", title = "Gage 09146200")+ylim(0,15000)
plot9<-ggplot(gage_09408135, aes(x=date, y=average_monthly_discharge))+geom_line(color="red")+labs( x="", y="", title = "Gage 09408135")+ylim(0,15000)+scale_x_date(limits=as.Date(c("2000-01-01", "2021-12-31")))
plot10<-ggplot(gage_13046000, aes(x=date, y=average_monthly_discharge))+geom_line(color="red")+labs(x="", y="", title = "Gage 13046000")+ylim(0,15000)

discharge_plot<-plot_grid(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot9, plot10, ncol = 3, align="hv")

title_gg <- ggplot() + labs(title = "Discharge Measurements for Streams Associated with Hydropower Generation", subtitle = "Blue indicates eastern states while red indicates western states.")

discharge_plot_grid<-plot_grid(title_gg, discharge_plot, ncol = 1, rel_heights = c(0.08,1))+theme(plot.margin=margin(10,5,10,10))

y.grob_dis<-textGrob(~"Average Monthly Discharge "(ft^3/s), 
                   gp=gpar(col="black", fontsize=10), rot=90)

grid.arrange(arrangeGrob(discharge_plot_grid, left = y.grob_dis))

```

## Data Analysis

Testing for trends in discharge and generation data.

```{r}
gage_01054500_ts<-ts(gage_01054500[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_01054500<-stl(gage_01054500_ts, s.window = "periodic")
plot(decom_01054500)
trend_gage_01054500<-smk.test(gage_01054500_ts)
trend_gage_01054500
summary(trend_gage_01054500)


gage_01563200_ts<-ts(gage_01563200[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_01563200<- stl(gage_01563200_ts, s.window = "periodic")
plot(decom_01563200)
trend_gage_01563200<-smk.test(gage_01563200_ts)
trend_gage_01563200
summary(trend_gage_01563200)


gage_02071000_ts<-ts(gage_02071000[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_02071000<- stl(gage_02071000_ts, s.window = "periodic")
plot(decom_02071000)
trend_gage_02071000<-smk.test(gage_02071000_ts)
trend_gage_02071000
summary(trend_gage_02071000)


gage_02143000_ts<-ts(gage_02143000[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_02143000<- stl(gage_02143000_ts, s.window = "periodic")
plot(decom_02143000)
trend_gage_02143000<-smk.test(gage_02143000_ts)
trend_gage_02143000
summary(trend_gage_02143000)



gage_02163001_ts<-ts(gage_02163001[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_02163001<- stl(gage_02163001_ts, s.window = "periodic")
plot(decom_02163001)
trend_gage_02163001<-smk.test(gage_02163001_ts)
trend_gage_02163001
summary(trend_gage_02163001)



gage_06279940_ts<-ts(gage_06279940[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_06279940<- stl(gage_06279940_ts, s.window = "periodic")
plot(decom_06279940)
trend_gage_06279940<-smk.test(gage_06279940_ts)
trend_gage_06279940
summary(trend_gage_06279940)



gage_09146200_ts<-ts(gage_09146200[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_09146200<- stl(gage_09146200_ts, s.window = "periodic")
plot(decom_09146200)
trend_gage_09146200<-smk.test(gage_09146200_ts)
trend_gage_09146200
summary(trend_gage_09146200)


gage_09408135_ts<-ts(gage_09408135[[3]], frequency = 12,  start = c(2005, 1), end = c(2021, 12))
decom_09408135<- stl(gage_09408135_ts, s.window = "periodic")
plot(decom_09408135)
trend_gage_09408135<-smk.test(gage_09408135_ts)
trend_gage_09408135
summary(trend_gage_09408135)


gage_13046000_ts<-ts(gage_13046000[[3]], frequency = 12,  start = c(2000, 1), end = c(2021, 12))
decom_13046000<- stl(gage_13046000_ts, s.window = "periodic")
plot(decom_13046000)
trend_gage_13046000<-smk.test(gage_13046000_ts)
trend_gage_13046000
summary(trend_gage_13046000)
#kable(trend_gage_13046000)


```

```{r}
f_month_1<- month(first(High_Shoals_Generation_Complete$Date))
f_year_1<- year(first((High_Shoals_Generation_Complete$Date)))
high_shoals_ts<- ts(High_Shoals_Generation_Complete$Power,
                   start=c(f_year_1,f_month_1),
                   frequency=12)

f_month_2<- month(first(Schoolfield_Generation_Complete$Date))
f_year_2<- year(first((Schoolfield_Generation_Complete$Date)))
schoolfield_ts<- ts(Schoolfield_Generation_Complete$Power,
                   start=c(f_year_2,f_month_2),
                   frequency=12)

f_month_3<- month(first(Matson_Generation_Complete$Date))
f_year_3<- year(first((Matson_Generation_Complete$Date)))
matson_ts<- ts(Matson_Generation_Complete$Power,
                   start=c(f_year_3,f_month_3),
                   frequency=12)

f_month_4<- month(first(Otis_Generation_Complete$Date))
f_year_4<- year(first((Otis_Generation_Complete$Date)))
otis_ts<- ts(Otis_Generation_Complete$Power,
                   start=c(f_year_4,f_month_4),
                   frequency=12)

f_month_5<- month(first(Ware_Shoals_Generation_Complete$Date))
f_year_5<- year(first((Ware_Shoals_Generation_Complete$Date)))
ware_shoals_ts<- ts(Ware_Shoals_Generation_Complete$Power,
                   start=c(f_year_5,f_month_5),
                   frequency=12)

f_month_6<- month(first(Garland_Generation_Complete$Date))
f_year_6<- year(first((Garland_Generation_Complete$Date)))
garland_ts<- ts(Garland_Generation_Complete$Power,
                   start=c(f_year_6,f_month_6),
                   frequency=12)

f_month_7<- month(first(Chester_Generation_Complete$Date))
f_year_7<- year(first((Chester_Generation_Complete$Date)))
chester_ts<- ts(Chester_Generation_Complete$Power,
                   start=c(f_year_7,f_month_7),
                   frequency=12)


f_month_8<- month(first(Tri_County_Generation_Complete$Date))
f_year_8<- year(first((Tri_County_Generation_Complete$Date)))
tri_county_ts<- ts(Tri_County_Generation_Complete$Power,
                   start=c(f_year_8,f_month_8),
                   frequency=12)


f_month_10<- month(first(Quail_Creek_Generation_Complete$Date))
f_year_10<- year(first((Quail_Creek_Generation_Complete$Date)))
quail_creek_ts<- ts(Quail_Creek_Generation_Complete$Power,
                   start=c(f_year_10,f_month_10),
                   frequency=12)

High_Shoals_Generation_Decomposed <- stl(high_shoals_ts, s.window = "periodic")
Schoolfield_Generation_Decomposed <- stl(schoolfield_ts, s.window = "periodic")
Matson_Generation_Decomposed <- stl(matson_ts, s.window = "periodic")
Otis_Generation_Decomposed <- stl(otis_ts, s.window = "periodic")
Ware_Shoals_Generation_Decomposed <- stl(ware_shoals_ts, s.window = "periodic")
Garland_Generation_Decomposed <- stl(garland_ts, s.window = "periodic")
Chester_Generation_Decomposed <- stl(chester_ts, s.window = "periodic")
Tri_County_Generation_Decomposed <- stl(tri_county_ts, s.window = "periodic")
Quail_Creek_Generation_Decomposed <- stl(quail_creek_ts, s.window = "periodic")

High_Shoals_Generation_Components <-as.data.frame(High_Shoals_Generation_Decomposed$time.series[,1:3])
Schoolfield_Generation_Components <- as.data.frame(Schoolfield_Generation_Decomposed$time.series[,1:3])
Matson_Generation_Components <- as.data.frame(Matson_Generation_Decomposed$time.series[,1:3])
Otis_Generation_Components <- as.data.frame(Otis_Generation_Decomposed$time.series[,1:3])
Ware_Shoals_Generation_Components <- as.data.frame(Ware_Shoals_Generation_Decomposed$time.series[,1:3])
Garland_Generation_Components <- as.data.frame(Garland_Generation_Decomposed$time.series[,1:3])
Chester_Generation_Components <- as.data.frame(Chester_Generation_Decomposed$time.series[,1:3])
Tri_County_Generation_Components <- as.data.frame(Tri_County_Generation_Decomposed$time.series[,1:3])
Quail_Creek_Generation_Components <- as.data.frame(Quail_Creek_Generation_Decomposed$time.series[,1:3])

High_Shoals_Generation_Components <- mutate(High_Shoals_Generation_Components,
        Observed = High_Shoals_Generation_Complete$Power,     
        Date = High_Shoals_Generation_Complete$Date)


Schoolfield_Generation_Components <- mutate(Schoolfield_Generation_Components,
        Observed = Schoolfield_Generation_Complete$Power,     
        Date = Schoolfield_Generation_Complete$Date)


Matson_Generation_Components <- mutate(Matson_Generation_Components,
        Observed = Matson_Generation_Complete$Power,     
        Date = Matson_Generation_Complete$Date)


Otis_Generation_Components <- mutate(Otis_Generation_Components,
        Observed = Otis_Generation_Complete$Power,     
        Date = Otis_Generation_Complete$Date)


Ware_Shoals_Generation_Components <- mutate(Ware_Shoals_Generation_Components,
        Observed = Ware_Shoals_Generation_Complete$Power,     
        Date = Ware_Shoals_Generation_Complete$Date)

Garland_Generation_Components <- mutate(Garland_Generation_Components,
        Observed = Garland_Generation_Complete$Power,     
        Date = Garland_Generation_Complete$Date)


Chester_Generation_Components <- mutate(Chester_Generation_Components,
        Observed = Chester_Generation_Complete$Power,     
        Date = Chester_Generation_Complete$Date)


Tri_County_Generation_Components <- mutate(Tri_County_Generation_Components,
        Observed = Tri_County_Generation_Complete$Power,     
        Date = Tri_County_Generation_Complete$Date)



Quail_Creek_Generation_Components <- mutate(Quail_Creek_Generation_Components,
        Observed = Quail_Creek_Generation_Complete$Power,     
        Date = Quail_Creek_Generation_Complete$Date)

# Run SMK test
high_shoals_trend1 <- Kendall::SeasonalMannKendall(high_shoals_ts)
# Inspect results
high_shoals_trend1
summary(high_shoals_trend1)

# Run SMK test
schoolfield_trend1 <- Kendall::SeasonalMannKendall(schoolfield_ts)
# Inspect results
schoolfield_trend1
summary(schoolfield_trend1)

# Run SMK test
matson_trend1 <- Kendall::SeasonalMannKendall(matson_ts)
# Inspect results
matson_trend1
summary(matson_trend1)

# Run SMK test
otis_trend1 <- Kendall::SeasonalMannKendall(otis_ts)
# Inspect results
otis_trend1
summary(otis_trend1)

# Run SMK test
ware_shoals_trend1 <- Kendall::SeasonalMannKendall(ware_shoals_ts)
# Inspect results
ware_shoals_trend1
summary(ware_shoals_trend1)


# Run SMK test
garland_trend1 <- Kendall::SeasonalMannKendall(garland_ts)
# Inspect results
garland_trend1
summary(garland_trend1)


# Run SMK test
chester_trend1 <- Kendall::SeasonalMannKendall(chester_ts)
# Inspect results
chester_trend1
summary(chester_trend1)


# Run SMK test
tri_county_trend1 <- Kendall::SeasonalMannKendall(tri_county_ts)
# Inspect results
tri_county_trend1
summary(tri_county_trend1)


# Run SMK test
quail_creek_trend1 <- Kendall::SeasonalMannKendall(quail_creek_ts)
# Inspect results
quail_creek_trend1
summary(quail_creek_trend1)


```

High Shoals, Ware Shoals, Tri County, and Quail Creek all demonstrate trends, as their 2-sided p value were below 0.5 and thus the null hypothesis was rejected. 

```{r}
# Visualize how the trend maps onto the data

ggplot(High_Shoals_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ggtitle("High Shoals Trend Analysis")+
  ylab(expression("Power (MWh)"))


ggplot(Schoolfield_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ggtitle("Schoolfield Trend Analysis")+
  ylab(expression("Power (MWh)"))

ggplot(Matson_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Otis_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Ware_Shoals_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Garland_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Chester_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Tri_County_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ggtitle("Tri County Trend Analysis")+
  ylab(expression("Power (MWh)"))


ggplot(Quail_Creek_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = trend, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

# Visualize how the seasonal cycle maps onto the data
ggplot(High_Shoals_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  ggtitle("High Shoals Seasonality Analysis")+
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Schoolfield_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Matson_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Otis_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

ggplot(Ware_Shoals_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Garland_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Chester_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))


ggplot(Tri_County_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))



ggplot(Quail_Creek_Generation_Components) +
  geom_line(aes(y = Observed, x = Date),  size = 0.25) +
  geom_line(aes(y = seasonal, x = Date), color = "#c13d75ff") +
  geom_hline(yintercept = 0, lty = 2) +
  ylab(expression("Power (MWh)"))

```

## Combining Datasets 

```{r}
#Matching the stream gage data to the power generation data.

#High Shoals Dam
high_shoals_power_water<-left_join(High_Shoals_Generation_Complete, gage_02143000)

ggplot(high_shoals_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="High Shoals")




schoolfield_power_water<-left_join(Schoolfield_Generation_Complete, gage_02071000)

ggplot(schoolfield_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Schoolfield")




william_f_matson_power_water<-left_join(Matson_Generation_Complete, gage_01563200)

ggplot(william_f_matson_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="William F Matson")




otis_power_water<-left_join(Otis_Generation_Complete, gage_01054500)

ggplot(otis_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(apha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Otis")




ware_power_water<-left_join(Ware_Shoals_Generation_Complete, gage_02163001)

ggplot(ware_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Ware Shoals")




garland_power_water<-left_join(Garland_Generation_Complete, gage_06279940)

ggplot(garland_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Garland")




chester_power_water<-left_join(Chester_Generation_Complete, gage_13046000)

ggplot(chester_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Chester")




tri_county_power_water<-left_join(Tri_County_Generation_Complete, gage_09146200)

ggplot(tri_county_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Tri County")




quail_power_water<-left_join(Quail_Creek_Generation_Complete, gage_09408135)

ggplot(quail_power_water, aes(x=average_monthly_discharge, y=Power))+geom_point(alpha=0.8)+labs(x=~"Average Monthly Discharge " (ft^3/s), y="Power (MWh)", title="Quail Creek")



```

```{r Hydro Generation PLotted Over Time}
#cowplots for hydro generation 

plot_hs<-ggplot(High_Shoals_Generation, aes(x=Date, y=Power))+geom_line(color="blue")+labs(x="", y="", title = "High Shoals")+ylim(0,16000)

plot_school<-ggplot(Schoolfield_Generation, aes(x=Date, y=Power))+geom_line(color="blue")+labs(x="", y="", title = "Schoolfield")+ylim(0,16000)

plot_matson<-ggplot(Matson_Generation, aes(x=Date, y=Power))+geom_line(color="blue")+labs(x="", y="", title = "Matson")+ylim(0,16000)

plot_otis<-ggplot(Otis_Generation, aes(x=Date, y=Power))+geom_line(color="blue")+labs(x="", y="", title = "Otis")+ylim(0,16000)

plot_ws<-ggplot(Ware_Shoals_Generation, aes(x=Date, y=Power))+geom_line(color="blue")+labs(x="", y="", title = "Ware Shoals")+ylim(0,16000)

plot_gar<-ggplot(Garland_Generation, aes(x=Date, y=Power))+geom_line(color="red")+labs(x="", y="", title = "Garland")+ylim(0,16000)

plot_ches<-ggplot(Chester_Generation, aes(x=Date, y=Power))+geom_line(color="red")+labs(x="", y="", title = "Chester")+ylim(0,16000)

plot_tri<-ggplot(Tri_County_Generation, aes(x=Date, y=Power))+geom_line(color="red")+labs(x="", y="", title = "Tri County")+ylim(0,16000)


plot_quail<-ggplot(Quail_Creek_Generation, aes(x=Date, y=Power))+geom_line(color="red")+labs(x="", y="", title = "Quail Creek")+ylim(0,16000)

power_plot<-plot_grid(plot_hs, plot_school, plot_matson, plot_otis, plot_ws, plot_gar, plot_ches, plot_tri,plot_quail, ncol = 3, align="hv")

title_gg_2 <- ggplot() + labs(title = "Hydropower Generation for Sampled Power Plants", subtitle = "Blue indicates eastern states while red indicates western states.")

plot_grid_power<-plot_grid(title_gg_2, power_plot, ncol = 1, rel_heights = c(0.08,1))+theme(plot.margin=margin(30, 10, 10, 10))

y.grob_power<-textGrob("Power Generation (MWh)", 
                   gp=gpar(col="black", fontsize=10), rot=90)

grid.arrange(arrangeGrob(plot_grid_power, left = y.grob_power))



```


```{r}

#Visualization of Dams

#install.packages("maps")


locations <- read.csv("./Generation_Sites.csv", stringsAsFactors = TRUE) 
locations <- locations %>%
  rename(Plant_Name = ï..Name)

final_locations<-locations[-c(9),]

states <- st_as_sf(maps::map(database = "state", plot = TRUE, fill = TRUE, col = "white"))

#Convert to a spatial dataframe
locations.sf <- final_locations %>% 
  st_as_sf(coords = c('Longitude','Latitude'),
           crs=4326)

mapview(locations.sf, cex = "MW")



gage_sites_lat_long<- read.csv("./Processed_data/gage_sites_lat_long.csv")

gage_sites_lat_long<-gage_sites_lat_long[-c(10,11), ] 

locations.gs <- gage_sites_lat_long %>% 
  rename(lat = ï..lat)%>%
  st_as_sf(coords = c('long','lat'),
           crs=4326)

ggplot()+geom_sf(data= states, fill = "white")+geom_sf(data= locations.sf)+geom_sf(data=locations.gs, col="red", alpha=0.5)


```


```{r}
#testing whether there is a linear relationship between streamflow and power generation 

high_shoals_regression <- lm(data = high_shoals_power_water, Power ~ average_monthly_discharge)
summary(high_shoals_regression)


schoolfield_regression <- lm(data = schoolfield_power_water, Power ~ average_monthly_discharge)
summary(schoolfield_regression)

matson_regression <- lm(data = william_f_matson_power_water, Power ~ average_monthly_discharge)
summary(matson_regression)

otis_regression <- lm(data = otis_power_water, Power ~ average_monthly_discharge)
summary(otis_regression)

ware_shoals_regression <- lm(data = ware_power_water, Power ~ average_monthly_discharge)
summary(ware_shoals_regression)

garland_regression <- lm(data =garland_power_water, Power ~ average_monthly_discharge)
summary(garland_regression)

chester_regression <- lm(data = chester_power_water, Power ~ average_monthly_discharge)
summary(chester_regression)

tri_county_regression <- lm(data = tri_county_power_water, Power ~ average_monthly_discharge)
summary(tri_county_regression)

quail_regression <- lm(data = quail_power_water, Power ~ average_monthly_discharge)
summary(quail_regression)











```


## Results 